// Azure Functions - Bicep module
// Generated by NubesGen (www.nubesgen.com)

@description('The name of your application')
param applicationName string

@description('The environment (dev, test, prod, ...')
@maxLength(4)
param environment string = 'dev'

@description('The number of this specific instance')
@maxLength(3)
param instanceNumber string = '001'

@description('The Azure region where all resources in this example should be created')
param location string

@description('An array of NameValues that needs to be added as environment variables')
param environmentVariables array

@description('A list of tags to apply to the resources')
param resourceTags object

var appServicePlanName = 'plan-${applicationName}-${environment}-${instanceNumber}'

resource storageAccount 'Microsoft.Storage/storageAccounts@2019-06-01' = {
  name: 'stf${take(applicationName,4)}${instanceNumber}'
  location: location
  kind: 'StorageV2'
  tags: resourceTags
  sku: {
    name: 'Standard_LRS'
  }
}

resource hostingPlan 'Microsoft.Web/serverfarms@2020-10-01' = {
  name: appServicePlanName
  location: location
  tags: resourceTags
{{#applicationTierConsumption}}
  kind: 'functionapp'
{{/applicationTierConsumption}}
{{#applicationTierPremium}}
  kind: 'elastic'
{{/applicationTierPremium}}  
  properties: {
    reserved: true
  }
  sku: {
{{#applicationTierConsumption}}
    name: 'Y1' 
{{/applicationTierConsumption}}
{{#applicationTierPremium}}
    name: 'EP1' 
    capacity: 1
{{/applicationTierPremium}}
  }
}

resource functionApp 'Microsoft.Web/sites@2020-06-01' = {
  name: 'app-${applicationName}-${environment}-${instanceNumber}'
  location: location
  kind: 'functionapp,linux'
  properties: {
    httpsOnly: true
    serverFarmId: hostingPlan.id
    clientAffinityEnabled: false
    siteConfig: {
{{#runtimeJava}}
      linuxFxVersion: 'java|11'
{{/runtimeJava}}
{{#runtimeDotnet}}
      linuxFxVersion: 'DOTNET|6.0'
{{/runtimeDotnet}}
{{#runtimeNodejs}}
      linuxFxVersion: 'Node|16'
{{/runtimeNodejs}}
      appSettings: union(environmentVariables, [
        
        // {
        //   'name': 'APPINSIGHTS_INSTRUMENTATIONKEY'
        //   'value': appInsights.properties.InstrumentationKey
        // }
        {
          name: 'AzureWebJobsStorage'
          value: 'DefaultEndpointsProtocol=https;AccountName=${storageAccount.name};EndpointSuffix=${az.environment().suffixes.storage};AccountKey=${listKeys(storageAccount.id, storageAccount.apiVersion).keys[0].value}'
        }
        {
          'name': 'FUNCTIONS_EXTENSION_VERSION'
          'value': '~4'
        }
        {
          'name': 'FUNCTIONS_WORKER_RUNTIME'
{{#runtimeJava}}
          'value': 'java'
{{/runtimeJava}}
{{#runtimeDotnet}}
          'value': 'dotnet'
{{/runtimeDotnet}}
{{#runtimeNodejs}}
          'value': 'node'
{{/runtimeNodejs}}           
        }
        {
          name: 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING'
          value: 'DefaultEndpointsProtocol=https;AccountName=${storageAccount.name};EndpointSuffix=${az.environment().suffixes.storage};AccountKey=${listKeys(storageAccount.id, storageAccount.apiVersion).keys[0].value}'
        }
        {
          'name': 'WEBSITE_RUN_FROM_PACKAGE'
          'value': '1'
        }
      ])
    }
  }

  dependsOn: [
    hostingPlan
    storageAccount
  ]
}

output application_url string = functionApp.properties.hostNames[0]
